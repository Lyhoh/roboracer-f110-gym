# Controller Package

This package provides a lightweight **Pure Pursuit–based controller** for the Roboracer project.

---

## Overview

The controller package contains a single ROS 2 node:

- **`pp_overtake.py`**  
  A dual-agent Pure Pursuit controller that:
  - tracks a shared base path published by the global planner,
  - applies lateral offsets to generate separate ego and opponent paths,
  - allows the ego vehicle to temporarily switch to a local overtaking path.

Both vehicles are controlled using Ackermann steering commands.

---

## Control Method

### Pure Pursuit

The controller uses the classical **Pure Pursuit (PP)** algorithm:

- A lookahead target point is selected on the reference path.
- The lookahead distance grows with vehicle speed:  
  $ Ld = max(ld_{min}, ld_{min} + ld_k \cdot v) $
- Steering commands are:
  - rate-limited,
  - clamped to the vehicle steering limits.

The emphasis is on **robust and stable behavior**, rather than aggressive or time-optimal control.

---

## Path Handling

### Base Path (Global Planner)

- A single base path (typically a **centerline**) is received as a `WaypointArray`.
- Ego and opponent reference paths are generated by applying **lateral offsets** to this base path.
- If available, the speed profile (`vx_mps`) provided by the planner can be used for velocity control.

### Overtaking Path (Local Planner)

- The ego vehicle can switch to a locally planned overtaking path (`OTWpntArray`).
- When an overtaking path is received:
    - the ego controller follows the new geometry,
    - and optionally adopts the speed profile provided by the local planner.
- If the overtaking path becomes empty:
    - a short debounce period is applied,
    - then the controller falls back to the base path and restores the nominal speed policy.

> **Note (Centerline vs. Raceline):**  
> For improved control robustness, the controller currently tracks a centerline-based path by default; however, any well-conditioned raceline can be used directly without modifying the controller.

---

## ROS Interfaces

### Subscribed Topics

- `/ego_racecar/odom` (`nav_msgs/Odometry`)
- `/opp_racecar/odom` (`nav_msgs/Odometry`)
- Base path topic (e.g. `/global_centerline`)
- `/planner/avoidance/otwpnts` (`OTWpntArray`)
- `/perception/ready`
- `/local_planner/ready`

### Published Topics

- `/drive` (`AckermannDriveStamped`) – ego vehicle
- `/opp_drive` (`AckermannDriveStamped`) – opponent vehicle

---

## Key Parameters

> The controller exposes many parameters, but only a small subset is typically tuned.

### Vehicle & Control

```yaml
wheelbase: 0.33
steer_limit_deg: 24.0
publish_rate: 40.0
steering_rate_limit: 3.0
```

### Lateral Offsets
```yaml
lateral_offset_ego: -0.5   # meters, +left / -right
lateral_offset_opp:  0.5
```

### Lookahead (Pure Pursuit)
```yaml
ld_min_ego: 0.6
ld_k_ego:   0.3
ld_min_opp: 0.6
ld_k_opp:   0.3
```

### Speed Policy

Two mutually exclusive modes are supported:

#### Mode A: Path-Speed Following
```yaml
use_path_speed_ego: true
speed_scale_ego: 1.10
v_target_max_ego: 4.5
```

#### Mode B: Constant Target Speed
```yaml
use_path_speed_ego: false
v_target_ego: 2.0
```


A startup speed ramp is always applied:
```yaml
v_ramp_rate_ego: 2.0
```

### Overtake Mode (Ego Only)
```yaml
ot_use_path_speed_ego: true
ot_speed_scale_ego: 2.0
```

## Notes

- This controller is intentionally simple and modular.
- It can be replaced independently by more advanced control strategies.
- Its primary role is to provide a stable control backend for evaluating perception and planning performance.